<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <!-- MDUI CSS -->
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/mdui@1.0.1/dist/css/mdui.min.css"
            integrity="sha384-cLRrMq39HOZdvE0j6yBojO4+1PrHfB7a9l5qLcmRm/fiWXYY+CndJPmyu5FV/9Tw"
            crossorigin="anonymous"
    />

    <!-- Title -->
    <title>发布帖子 | QForum</title>
    <link rel="shortcut icon" href="../../img/favicon.png">
    <link rel="stylesheet" href="../../editor.md/css/editormd.css"/>
</head>
<body class="mdui-theme-primary-blue mdui-theme-accent-blue mdui-drawer-body-left mdui-appbar-with-toolbar" style="padding-bottom: 5%">
    <div id="appbar"></div>
    <div id="drawer"></div>

    <div class="mdui-container" style="margin: 5%">

    <div class="mdui-container mdui-typo" style="margin-bottom: 10px">
        <div class="mdui-textfield mdui-textfield-floating-label">
            <label for="appName" class="mdui-textfield-label" style="font-size: x-large">标题</label>
            <input id="appName" class="mdui-textfield-input" type="text"/>
        </div>
    </div>
        <div class="mdui-table-fluid" style="width: 90%;margin-left: 5%;margin-bottom: 10px">
            <table class="mdui-table" style="width: 90%">
                <tbody>
                <tr>
                    <td>分类</td>
                    <td id="tag_container"></td>
                </tr>
                <tr>
                    <td>包名</td>
                    <td><div class="mdui-textfield">
                        <input id="packageName" class="mdui-textfield-input" type="text" placeholder="包名"/>
                    </div></td>
                </tr>
                <tr>
                    <td>版本号</td>
                    <td><div class="mdui-textfield">
                        <input id="version" class="mdui-textfield-input" type="text" placeholder="版本号"/>

                    </div></td>
                </tr>
                <tr>
                    <td>简介</td>
                    <td><div class="mdui-textfield">
                        <input id="slogan" class="mdui-textfield-input" type="text" placeholder="简介"/>
                    </div></td>
                </tr>
                <tr>
                    <td>图标地址</td>
                    <td><div class="mdui-textfield">
                        <input id="iconUrl" class="mdui-textfield-input" type="url" placeholder="图标地址"/>
                    </div></td>
                </tr>
                <tr>
                    <td>下载地址</td>
                    <td><div class="mdui-textfield">
                        <input id="downloadUrl" class="mdui-textfield-input" type="url" placeholder="下载地址"/>
                    </div></td>
                </tr>

                </tbody>
            </table>
        </div>
    <div id="editor">
        <textarea style="display:none;"></textarea>
    </div>
        <button onclick="submit()" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" style="margin-right: 5%;float: right">发布应用</button>
    </div>


    <!-- MDUI JavaScript -->
    <script
            src="https://cdn.jsdelivr.net/npm/mdui@1.0.1/dist/js/mdui.min.js"
            integrity="sha384-gCMZcshYKOGRX9r6wbDrvF+TcCCswSHFucUzUPwka+Gr+uHgjlYvkABr95TCOz3A"
            crossorigin="anonymous"
    ></script>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script src="../../js/App_v1.js"></script>
    <script src="../../js/api/ThreadApi_v1.js"></script>
    <script src="../../js/api/TagApi_v1.js"></script>
    <script src="../../js/api/AppApi_v1.js"></script>
    <script src="../../js/util/NetWorkUtil_v2.js"></script>
    <script src="../../editor.md/editormd.min.js"></script>
    <script>
        let editor;
        if(getCookie("sessionId")==null){
            location.href = "../../";
        }
        $("#appbar").load("../../common/appbar.html", function (responseTxt, statusTxt) {
            if (statusTxt === "success") {
                $("#title").text("发布帖子");
            }
        });
        $("#drawer").load("../../common/drawer.html", function (responseTxt, statusTxt) {
            if (statusTxt === "success") {
                $("#main").attr("href","../../");
            }
        });
        $(function () {
            editormd.urls.atLinkBase = "../../user/?username=";
            editor = editormd("editor", {
                width: "90%",
                height: 640,
                syncScrolling: "single",
                placeholder: "请输入内容...",
                path: "../../editor.md/lib/",
                saveHTMLToTextarea: true,
                emoji:true,
                atLink:true,
                taskList:true,
                imageUpload : true,
                imageFormats : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
                imageUploadURL : "http://localhost:8080/image/upload",
                crossDomainUpload : true

            });

            let msg = getQueryStringByName("msg");
            if(msg){
                mdui.snackbar(msg);
            }
            listTags("",function (data){
                $("#tag_container").html('<select id="tags" className="mdui-select" mdui-select></select>')
                for(let i = 0;i<data["size"];i++){
                    $("#tags")
                        .append('<option value="' + data["tagList"][i]["id"] + '">' + data["tagList"][i]["name"] + '</option>'
                        );
                    if(data["size"]-i!==1){
                        $("#threads").append('<li class="mdui-divider-inset mdui-m-y-0" style="list-style: none"></li>');
                    }
                }
                mdui.mutation();
            });
        });
        function submit(){
            let params = {};
            params.sessionId = getCookie("sessionId");
            params.name = $("#appName").val();
            params.downloadUrl = $("#downloadUrl").val();
            params.iconUrl = $("#iconUrl").val();
            params.version = $("#version").val();
            params.slogan = $("#slogan").val();
            params.packageName = $("#packageName").val();
            params.description = editor.getHTML();
            params = $.param(params);
            postApp(params,function (data) {
                location.href = "../detail/?packageName="+data["packageName"]+"&msg=发布成功";
            },function (data) {
                mdui.snackbar(analysisError(data["error"]));
            });
        }

    </script>

</body>
</html>